CREATE DEFINER=`root`@`localhost` PROCEDURE `POWERBI_ORDERS`()
BEGIN
WITH FINAL_BUYER_SUMMARY AS(
	WITH BUYER_WISE_SUMMARY AS(
			SELECT DISTINCT
					LD.ORD_NUM,
					LD.BUYER,CONCAT(SUBSTRING(MONTHNAME(LD.DELIVERY_DATE), 1, 3), '-', YEAR(LD.DELIVERY_DATE)) AS ORD_MONTH,
					LD.INVOICE_NO,
					LD.PRICE,LD.CURRENT_CURRENCY_RATE ,
					LD.ORDER_QTY,
					LD.ORDER_VALUE_INR,
					LD.SHIP_QTY,
					LD.SHIP_VALUE_INR,
					CONCAT(SUBSTRING(MONTHNAME(LD.SHIP_DATE), 1, 3), '-', YEAR(LD.SHIP_DATE)) AS SHIP_MONTH,
					(MONTH(LD.DELIVERY_DATE)+8)%12+1 AS ORDERMONTH, 
					case 
						when month(LD.DELIVERY_DATE) between 4 and 12 then concat(year(LD.DELIVERY_DATE),'-',year(LD.DELIVERY_DATE)+1) 
						else concat(year(LD.DELIVERY_DATE)-1,'-',year(LD.DELIVERY_DATE)) 
					end as FinYear
				
				FROM Order_Details_Responses_Logistic.LOGISTIC_DETAILS AS LD 

				WHERE LD.DELIVERY_DATE >= '2023-04-01' 

    )
    
				SELECT 
					ORD_MONTH,
					BUYER, SUBSTRING_INDEX(ORD_NUM, '-', 1) AS ORD_NUM,
					ROUND(SUM(ORDER_QTY)) AS ORDER_QTY, 
					ROUND(SUM(ORDER_VALUE_INR)) AS ORDER_VALUE,
					IFNULL(SUM(SHIP_QTY),0) AS SHIPPED_QTY, 
					IFNULL(ROUND(SUM(SHIP_VALUE_INR)),0) AS SHIP_VALUE_INR,
					CASE 
						WHEN ROUND(7 * ROUND(SUM(ORDER_QTY))/100) >= ROUND(ROUND(SUM(ORDER_QTY)) - IFNULL(SUM(SHIP_QTY),0)) OR IFNULL(SUM(SHIP_QTY),0) >= ROUND(SUM(ORDER_QTY)) THEN 0
						ELSE ROUND(SUM(ORDER_QTY)) - IFNULL(SUM(SHIP_QTY),0)
					END AS REMAINING_QTY,
					CASE 
						WHEN ROUND(7 * ROUND(SUM(ORDER_QTY))/100) >= ROUND(ROUND(SUM(ORDER_QTY)) - IFNULL(SUM(SHIP_QTY),0)) OR IFNULL(SUM(SHIP_QTY),0) >= ROUND(SUM(ORDER_QTY)) THEN 0
						ELSE ROUND(SUM(ORDER_VALUE_INR)) - IFNULL(ROUND(SUM(SHIP_VALUE_INR)),0)
					END AS REMAINING_VALUE_INR,
					FinYear
				FROM BUYER_WISE_SUMMARY 
				GROUP BY BUYER, FinYear,SUBSTRING_INDEX(ORD_NUM, '-', 1),ORD_MONTH
    )
					
                    SELECT 
						ORD_MONTH AS MONTH,
						BUYER,
						SUM(ORDER_QTY) AS ORDER_QTY,
						SUM(ORDER_VALUE) AS ORDER_VALUE,
						SUM(REMAINING_QTY) AS REMAINING_QTY,
						SUM(REMAINING_VALUE_INR) AS REMAINING_VALUE_INR,
						FinYear
					FROM FINAL_BUYER_SUMMARY
					GROUP BY BUYER,FinYear,ORD_MONTH
					
;
END